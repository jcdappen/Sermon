
<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predigtplanung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .result-details[open] summary ~ * {
            animation: sweep .5s ease-in-out;
        }
        @keyframes sweep {
            0%    {opacity: 0; transform: translateY(-10px)}
            100%  {opacity: 1; transform: translateY(0)}
        }
    </style>
</head>
<body class="h-full font-sans text-gray-800">
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                        </svg>
                        <h1 class="text-2xl font-bold text-gray-900">Predigtplanung</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Left Column: Actions -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h2 class="text-lg font-semibold mb-4 text-gray-900 border-b pb-2">Setup & Synchronisation</h2>
                            
                            <!-- Test Connection -->
                            <div class="space-y-3 py-4 border-b">
                                <h3 class="font-medium text-gray-700">1. Verbindung testen</h3>
                                <p class="text-sm text-gray-500">Prüft, ob die ChurchTools API mit dem Token erreichbar ist.</p>
                                <button id="test-connection-btn" class="action-btn">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>
                                    <span>Verbindung testen</span>
                                    <div class="loader"></div>
                                </button>
                                <div id="test-connection-result" class="result-container"></div>
                            </div>

                            <!-- Get IDs -->
                            <div class="space-y-3 py-4 border-b">
                                <h3 class="font-medium text-gray-700">2. IDs ermitteln</h3>
                                <p class="text-sm text-gray-500">Findet die Kalender-ID für "Gottesdienst" und die Service-ID für "Prediger".</p>
                                <button id="get-ids-btn" class="action-btn">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                                    <span>IDs suchen</span>
                                    <div class="loader"></div>
                                </button>
                                <div id="get-ids-result" class="result-container"></div>
                            </div>

                            <!-- Sync Events -->
                            <div class="space-y-3 pt-4">
                                <h3 class="font-medium text-gray-700">3. Events synchronisieren</h3>
                                <p class="text-sm text-gray-500">Holt die Gottesdienst-Events für das nächste Jahr und speichert sie in der DB.</p>
                                <button id="sync-events-btn" class="action-btn">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-11.667-11.667a8.25 8.25 0 0 1 11.667 0l3.181 3.183m-11.667 0-3.181-3.183" /></svg>
                                    <span>Sync starten</span>
                                    <div class="loader"></div>
                                </button>
                                <div id="sync-events-result" class="result-container"></div>
                            </div>

                        </div>
                    </div>

                    <!-- Right Column: Events -->
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center border-b pb-2 mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Geplante Predigten</h2>
                                <button id="get-events-btn" class="action-btn">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201-4.42 5.5 5.5 0 0 1 8.25-6.204 1 1 0 0 1 1.667 1.332 5.5 5.5 0 0 1-1.333 3.667l1.01 1.01A.5.5 0 0 1 15.5 7.5v.062a1 1 0 0 0 .584.918 5.5 5.5 0 0 1 1.55 5.253 1 1 0 0 1-1.323 1.093Z" clip-rule="evenodd" /></svg>
                                    <span>Events laden</span>
                                    <div class="loader"></div>
                                </button>
                            </div>
                            <div id="events-list" class="space-y-4">
                                <div id="events-placeholder" class="text-center py-10">
                                    <p class="text-gray-500">Lade Events, um die Predigtplanung zu sehen.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const setupButton = (buttonId, endpoint, resultContainerId) => {
        const button = document.getElementById(buttonId);
        button.addEventListener('click', async () => {
            await handleApiCall(button, endpoint, resultContainerId);
        });
    };
    
    const getEventsButton = document.getElementById('get-events-btn');
    getEventsButton.addEventListener('click', loadAndRenderEvents);
    
    setupButton('test-connection-btn', '/api/test-churchtools', 'test-connection-result');
    setupButton('get-ids-btn', '/api/get-churchtools-ids', 'get-ids-result');
    setupButton('sync-events-btn', '/api/sync-events', 'sync-events-result');
    
    function showLoading(button, show) {
        const loader = button.querySelector('.loader');
        const icon = button.querySelector('svg');
        const text = button.querySelector('span');

        if (show) {
            button.disabled = true;
            button.classList.add('cursor-not-allowed', 'opacity-75');
            if (loader) loader.style.display = 'inline-block';
            if (icon) icon.style.display = 'none';
        } else {
            button.disabled = false;
            button.classList.remove('cursor-not-allowed', 'opacity-75');
            if (loader) loader.style.display = 'none';
            if (icon) icon.style.display = 'inline-flex';
        }
    }

    function renderResult(containerId, data, success = true) {
        const container = document.getElementById(containerId);
        const title = success ? (data.message || 'Erfolgreiche Antwort') : 'Fehler';
        const bgColor = success ? 'bg-green-50' : 'bg-red-50';
        const borderColor = success ? 'border-green-200' : 'border-red-200';
        const textColor = success ? 'text-green-800' : 'text-red-800';

        let contentHtml = `<pre class="text-xs p-3 bg-gray-800 text-white rounded-md overflow-x-auto"><code>${JSON.stringify(data, null, 2)}</code></pre>`;

        container.innerHTML = `
            <details class="result-details mt-4 border ${borderColor} ${bgColor} rounded-lg overflow-hidden">
                <summary class="cursor-pointer p-3 font-medium ${textColor} flex justify-between items-center">
                    <span>${title}</span>
                    <svg class="w-4 h-4 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </summary>
                <div class="p-4 border-t ${borderColor}">
                    ${contentHtml}
                </div>
            </details>
        `;
        container.querySelector('details').open = true;
    }
    
    async function handleApiCall(button, endpoint, resultContainerId) {
        showLoading(button, true);
        const resultContainer = document.getElementById(resultContainerId);
        resultContainer.innerHTML = '';
        
        try {
            const response = await fetch(endpoint, { method: 'POST' });
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Ein unbekannter Fehler ist aufgetreten.');
            }
            
            renderResult(resultContainerId, data);
        } catch (error) {
            renderResult(resultContainerId, { error: error.message, details: 'Prüfe die Browser-Konsole und die Netlify Function Logs für mehr Details.' }, false);
        } finally {
            showLoading(button, false);
        }
    }

    async function loadAndRenderEvents() {
        const button = document.getElementById('get-events-btn');
        showLoading(button, true);

        const eventsList = document.getElementById('events-list');
        const placeholder = document.getElementById('events-placeholder');

        try {
            const response = await fetch('/api/get-events');
            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.error || 'Konnte Events nicht laden.');
            }

            if (placeholder) placeholder.style.display = 'none';
            eventsList.innerHTML = ''; // Clear previous list

            if (result.data && result.data.length > 0) {
                result.data.forEach(event => {
                    eventsList.appendChild(createEventCard(event));
                });
            } else {
                 if (placeholder) {
                    placeholder.innerHTML = '<p class="text-gray-500">Keine Events in der Datenbank gefunden. Bitte synchronisiere zuerst.</p>';
                    placeholder.style.display = 'block';
                 }
            }
        } catch (error) {
            if (placeholder) {
                placeholder.innerHTML = `<p class="text-red-500">Fehler beim Laden: ${error.message}</p>`;
                placeholder.style.display = 'block';
            }
        } finally {
            showLoading(button, false);
        }
    }
    
    function createEventCard(event) {
        const card = document.createElement('div');
        card.className = 'border rounded-lg p-4 bg-gray-50 flex flex-col md:flex-row md:items-center justify-between space-y-3 md:space-y-0';
        
        const date = new Date(event.date);
        const formattedDate = date.toLocaleDateString('de-DE', { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' });

        const preacherInfo = event.preacher_name 
            ? `<div class="flex items-center space-x-2">
                 <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 0 .41 1.412A9.957 9.957 0 0 0 10 18c2.31 0 4.438-.784 6.131-2.095a1.23 1.23 0 0 0 .41-1.412A9.992 9.992 0 0 0 10 12c-2.31 0-4.438.784-6.131 2.095Z" /></svg>
                 <span class="font-medium">${event.preacher_name}</span>
               </div>`
            : `<span class="text-sm text-gray-400 italic">Noch nicht besetzt</span>`;

        const topicInfo = event.theme_topic
            ? `<div class="flex items-center space-x-2 mt-1">
                 <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0 0 1.5h11.5a.75.75 0 0 0 0-1.5H4.25Zm0 4a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5Z" clip-rule="evenodd" /></svg>
                 <span class="text-sm text-gray-600">${event.theme_topic}</span>
               </div>`
            : '';

        card.innerHTML = `
            <div class="flex-grow">
                <div class="flex items-center space-x-3">
                    <span class="font-bold text-indigo-600">${formattedDate}</span>
                    <h4 class="text-md font-semibold text-gray-800">${event.title}</h4>
                </div>
                <div class="pl-12 mt-2 space-y-1">
                    ${preacherInfo}
                    ${topicInfo}
                </div>
            </div>
            <div class="flex-shrink-0">
                <button class="edit-btn" data-event-id="${event.id}">
                    <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.885L17.5 5.5a2.121 2.121 0 0 0-3-3L3.58 13.42a4 4 0 0 0-.885 1.343Z" /></svg>
                    Bearbeiten
                </button>
            </div>
        `;

        card.querySelector('.edit-btn').addEventListener('click', () => {
            alert('Bearbeiten-Funktion (Phase 4/5) ist noch nicht implementiert.');
        });
        
        return card;
    }

    // Add some shared styles dynamically
    const style = document.createElement('style');
    style.innerHTML = `
        .action-btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 6px; 
            background-color: white; font-weight: 500; color: #374151;
            transition: all 0.15s ease-in-out;
            width: 100%;
        }
        .action-btn:hover { background-color: #f9fafb; }
        .action-btn:focus { outline: 2px solid #4f46e5; outline-offset: 2px; }
        .action-btn svg { margin-right: 8px; }
        .edit-btn {
            display: inline-flex; align-items: center; padding: 6px 12px;
            border-radius: 6px; background-color: #f0f0f0; font-weight: 500;
            color: #4b5563; font-size: 14px;
        }
        .edit-btn:hover { background-color: #e5e7eb; }
        .loader {
            display: none;
            width: 16px; height: 16px; border: 2px solid #e5e7eb;
            border-top-color: #4f46e5; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .result-details summary::-webkit-details-marker { display: none; }
        .result-details[open] summary svg { transform: rotate(180deg); }
    `;
    document.head.appendChild(style);
});
</script>
</body>
</html>
